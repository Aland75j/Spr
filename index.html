<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAXIOM R4 | STABLE BEAST</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDE6qMplWktZASB2AjUKuY_dSRCUKiZyOA",
            authDomain: "maxiom-r3.firebaseapp.com",
            databaseURL: "https://maxiom-r3-default-rtdb.firebaseio.com",
            projectId: "maxiom-r3",
            storageBucket: "maxiom-r3.firebasestorage.app",
            messagingSenderId: "221473460329",
            appId: "1:221473460329:web:21a278a86cfdcff8b1d2f8",
            measurementId: "G-82WFV6S568"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // IP Protection
        (async function() {
            try {
                const r = await fetch('https://api.ipify.org?format=json');
                const d = await r.json();
                db.ref('banned_ips').on('value', (snap) => {
                    if((snap.val() || []).includes(d.ip)) {
                        document.body.innerHTML = "<div style='background:black;color:red;height:100vh;display:flex;align-items:center;justify-content:center;font-family:monospace;'><h1>ACCESS_DENIED_BY_ADMIN</h1></div>";
                    }
                });
            } catch(e) {}

            db.ref('settings/paypal_id').once('value', (snap) => {
                const script = document.createElement('script');
                script.src = `https://www.paypal.com/sdk/js?client-id=${snap.val() || "test"}&currency=USD`;
                document.head.appendChild(script);
            });
        })();
    </script>

    <style>
        :root {
            --primary: #ffd700;
            --secondary: #ff0000;
            --bg-main: #020202;
            --glass: rgba(0, 0, 0, 0.95);
        }
        .blue-theme { --primary: #00d4ff; --secondary: #0044ff; --bg-main: #000510; }

        * { cursor: crosshair !important; box-sizing: border-box; }
        body { margin: 0; font-family: 'Courier New', monospace; color: white; background: var(--bg-main); transition: 0.5s; overflow-x: hidden; }

        /* [FIX] Layout Layers */
        #global-canvas { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        
        #loader-overlay {
            position: fixed; inset: 0; background: #000; z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        header { padding: 40px 0; font-size: clamp(24px, 8vw, 50px); color: var(--primary); text-shadow: 0 0 20px var(--primary); letter-spacing: 5px; font-weight: bold; }

        /* [FIX] Product Grid Logic */
        .product-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 25px; 
            padding: 20px; 
            max-width: 1400px; 
            margin: auto; 
        }

        .product { 
            background: var(--glass); 
            border: 1px solid #222; 
            padding: 15px; 
            border-radius: 12px; 
            transition: 0.3s ease; 
            position: relative;
        }
        .product:hover { transform: translateY(-8px); border-color: var(--primary); box-shadow: 0 0 15px var(--primary); }
        .product img { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; cursor: pointer; }

        /* Navigation */
        .floating-nav { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; gap: 10px; }
        .cart-trigger { 
            width: 60px; height: 60px; background: var(--primary); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; color: black; 
            font-size: 24px; font-weight: bold; border: 3px solid white; box-shadow: 0 0 15px var(--primary);
        }

        /* UI Overlays */
        .admin-box { display: none; position: fixed; inset: 0; background: #000; z-index: 20000; padding: 20px; overflow-y: auto; }
        .panel { background: #0a0a0a; border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        
        input, select, textarea { width: 100%; background: #000; border: 1px solid var(--primary); color: white; padding: 12px; margin: 8px 0; border-radius: 5px; }
        .ui-btn { padding: 12px 20px; background: var(--primary); color: black; border: none; font-weight: bold; border-radius: 5px; cursor: pointer; }
        .ui-btn:hover { filter: brightness(1.2); }

        #alert-banner { display: none; position: fixed; top: 0; width: 100%; background: var(--secondary); padding: 10px; z-index: 100001; text-align: center; font-weight: bold; }
        
        @media (max-width: 600px) {
            .product-grid { grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
            .product { padding: 8px; }
            .product img { height: 120px; }
            header { padding: 20px 0; }
        }
    </style>
</head>
<body onclick="initSystem()">

<div id="alert-banner"></div>

<div id="loader-overlay">
    <div style="color: var(--primary); font-family: monospace; white-space: pre; line-height: 10px; font-size: 8px;">
        (SYSTEM INITIALIZING...)
    </div>
    <div style="width: 250px; height: 2px; background: #222; margin-top: 20px; position: relative;">
        <div id="load-bar" style="width: 0%; height: 100%; background: var(--primary); box-shadow: 0 0 10px var(--primary); transition: 0.1s;"></div>
    </div>
</div>

<canvas id="global-canvas"></canvas>

<div class="floating-nav">
    <button class="ui-btn" onclick="toggleTheme()">üåÄ</button>
    <div class="cart-trigger" onclick="showPage('checkout-page')">
        üõí <span id="cart-count" style="position:absolute; top:-5px; right:-5px; background:red; color:white; font-size:12px; padding:3px 7px; border-radius:50%;">0</span>
    </div>
</div>

<header onclick="showPage('shop-page')">SPR SHOP ARK R4</header>

<div id="shop-page" class="page">
    <div style="color:var(--primary); font-weight:bold; margin: 20px;">[ ANDROID MODULES ]</div>
    <div id="android-grid" class="product-grid"></div>
    <div style="color:var(--primary); font-weight:bold; margin: 40px 20px 20px 20px;">[ IOS MODULES ]</div>
    <div id="ios-grid" class="product-grid"></div>
</div>

<div id="info-page" class="page" style="display:none; padding: 20px;">
    <div style="max-width: 800px; margin: auto; background: var(--glass); border: 2px solid var(--primary); padding: 25px; border-radius: 15px;">
        <img id="info-img" style="width:100%; max-height: 400px; object-fit: contain; border-radius: 10px;">
        <h1 id="info-title" style="color:var(--primary)"></h1>
        <h2 id="info-price" style="color:var(--primary)"></h2>
        <p id="info-desc" style="line-height: 1.6;"></p>
        <div id="info-actions"></div>
        <br>
        <button class="ui-btn" style="background:gray;" onclick="showPage('shop-page')">BACK TO SHOP</button>
    </div>
</div>

<div id="checkout-page" class="page" style="display:none; padding: 20px;">
    <div style="max-width: 600px; margin: auto; background: var(--glass); border: 1px solid var(--primary); padding: 30px; border-radius: 10px;">
        <h2 style="color:var(--primary)">ORDER MANIFEST</h2>
        <div id="cart-list" style="text-align: left; margin: 20px 0;"></div>
        <input type="text" id="coupon-code" placeholder="ENTER COUPON">
        <button class="ui-btn" style="width: 100%;" onclick="applyDiscount()">APPLY CODE</button>
        <h1 id="total-display" style="margin: 30px 0;">TOTAL: $0</h1>
        <div id="paypal-btn-area"></div>
        <button class="ui-btn" style="width: 100%; background: red; margin-top: 10px;" onclick="clearCart()">WIPE CART</button>
    </div>
</div>

<div class="admin-box" id="admin-panel">
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <h2 style="color: red;">R4_CORE_ACCESS</h2>
        <button class="ui-btn" style="background: red;" onclick="closeAdmin()">LOGOUT</button>
    </div>

    <div id="admin-login" style="text-align: center; margin-top: 100px;">
        <input type="password" id="admin-key" placeholder="ROOT KEY" style="max-width: 300px;">
        <button class="ui-btn" style="width: 300px; display: block; margin: 10px auto;" onclick="tryLogin()">DECRYPT HUB</button>
    </div>

    <div id="admin-ui" style="display: none;">
        <div class="panel">
            <h3>‚öíÔ∏è ARSENAL FORGE</h3>
            <input type="hidden" id="edit-id" value="-1">
            <input type="text" id="p-name" placeholder="Name">
            <input type="number" id="p-price" placeholder="Price">
            <input type="text" id="p-yt" placeholder="YouTube ID">
            <select id="p-cat"><option value="android">Android</option><option value="ios">IOS</option></select>
            <textarea id="p-desc" placeholder="Description"></textarea>
            <label>Image:</label><input type="file" id="p-img">
            <label>Delivery File:</label><input type="file" id="p-file">
            <button class="ui-btn" id="forge-btn" onclick="saveProduct()">DEPLOY ASSET</button>
            <button class="ui-btn" id="cancel-edit" style="background:gray; display:none;" onclick="resetForge()">CANCEL</button>
        </div>
        <div id="admin-asset-list"></div>
    </div>
</div>

<audio id="bg-music" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
<audio id="click-sound" src="https://www.myinstants.com/media/sounds/sword-slash.mp3"></audio>

<script>
let products = [], cart = [], coupons = {}, isAdmin = false, discount = 0, systemReady = false;

// [FIXED] Audio Initialization
function initSystem() {
    if(!systemReady) {
        document.getElementById('bg-music').play().catch(()=>{});
        systemReady = true;
    }
}

function playSound() {
    const s = document.getElementById('click-sound');
    s.currentTime = 0;
    s.play().catch(()=>{});
}

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    window.scrollTo(0,0);
    playSound();
}

// Shop Logic
function loadProducts() {
    db.ref('products').on('value', (s) => {
        products = s.val() || [];
        const ag = document.getElementById('android-grid'), ig = document.getElementById('ios-grid');
        ag.innerHTML = ""; ig.innerHTML = "";
        products.forEach((p, i) => {
            if(!p) return;
            const card = document.createElement('div'); card.className = "product";
            card.innerHTML = `
                <img src="${p.image || ''}" onclick="openInfo(${i})">
                <h3 style="margin:10px 0 5px;">${p.name}</h3>
                <div style="color:var(--primary); font-weight:bold;">$${p.price}</div>
                <button class="ui-btn" style="width:100%; margin-top:10px;" onclick="addCart(${i})">ADD TO CART</button>
            `;
            p.category === 'ios' ? ig.appendChild(card) : ag.appendChild(card);
        });
        if(isAdmin) renderAdminList();
    });
}

function openInfo(i) {
    const p = products[i];
    showPage('info-page');
    document.getElementById('info-img').src = p.image || '';
    document.getElementById('info-title').innerText = p.name;
    document.getElementById('info-price').innerText = "$"+p.price;
    document.getElementById('info-desc').innerText = p.desc;
    document.getElementById('info-actions').innerHTML = `
        <button class="ui-btn" style="width:100%;" onclick="addCart(${i})">ADD TO CART</button>
        ${p.yt ? `<button class="ui-btn" style="width:100%; background:red; margin-top:10px;" onclick="window.open('https://youtube.com/watch?v=${p.yt}')">WATCH PREVIEW</button>` : ''}
    `;
}

function addCart(i) {
    cart.push(products[i]);
    document.getElementById('cart-count').innerText = cart.length;
    playSound();
    renderCart();
}

function renderCart() {
    const list = document.getElementById('cart-list');
    let total = 0; list.innerHTML = "";
    cart.forEach((item, idx) => {
        list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333;">
            <span>${item.name}</span><span>$${item.price}</span>
        </div>`;
        total += parseFloat(item.price);
    });
    let final = total - (total * (discount/100));
    document.getElementById('total-display').innerText = "TOTAL: $" + final.toFixed(2);
    
    // Reset PayPal area
    const area = document.getElementById('paypal-btn-area');
    area.innerHTML = "";
    if(cart.length > 0) {
        paypal.Buttons({
            createOrder: (data, actions) => actions.order.create({ purchase_units: [{ amount: { value: final.toFixed(2) } }] }),
            onApprove: (data, actions) => actions.order.capture().then(det => {
                cart.forEach(item => {
                    if(item.delivery) {
                        const a = document.createElement('a'); a.href = item.delivery.data; a.download = item.delivery.name; a.click();
                    }
                });
                alert("PAYMENT SUCCESSFUL"); location.reload();
            })
        }).render('#paypal-btn-area');
    }
}

function clearCart() { cart = []; document.getElementById('cart-count').innerText = "0"; renderCart(); }

// Admin Hub
window.onkeydown = (e) => { if(e.key === "Insert") document.getElementById('admin-panel').style.display = 'block'; };
function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }

function tryLogin() {
    if(document.getElementById('admin-key').value === "spartytop1") {
        isAdmin = true;
        document.getElementById('admin-ui').style.display = 'block';
        document.getElementById('admin-login').style.display = 'none';
        renderAdminList();
    }
}

function saveProduct() {
    const id = document.getElementById('edit-id').value;
    const n = document.getElementById('p-name').value, p = document.getElementById('p-price').value;
    const fImg = document.getElementById('p-img').files[0], fFile = document.getElementById('p-file').files[0];
    
    const read = (f) => f ? new Promise(r => { const reader = new FileReader(); reader.onload=e=>r({data:e.target.result, name:f.name}); reader.readAsDataURL(f); }) : null;
    
    Promise.all([read(fImg), read(fFile)]).then(res => {
        let obj = {
            name: n, price: p, yt: document.getElementById('p-yt').value,
            category: document.getElementById('p-cat').value, desc: document.getElementById('p-desc').value,
            image: res[0] ? res[0].data : (id != -1 ? products[id].image : ""),
            delivery: res[1] ? res[1] : (id != -1 ? products[id].delivery : null)
        };
        if(id == -1) products.push(obj); else products[id] = obj;
        db.ref('products').set(products).then(() => { alert("SUCCESS"); resetForge(); });
    });
}

function renderAdminList() {
    const area = document.getElementById('admin-asset-list');
    area.innerHTML = products.map((p, i) => !p ? '' : `
        <div style="padding:10px; background:#111; border:1px solid #333; margin-top:5px; display:flex; justify-content:space-between;">
            <span>${p.name}</span>
            <div>
                <button onclick="editItem(${i})" style="color:lime; background:none; border:none; cursor:pointer;">EDIT</button>
                <button onclick="delItem(${i})" style="color:red; background:none; border:none; cursor:pointer; margin-left:10px;">DEL</button>
            </div>
        </div>
    `).join('');
}

function editItem(i) {
    const p = products[i];
    document.getElementById('p-name').value = p.name;
    document.getElementById('p-price').value = p.price;
    document.getElementById('p-yt').value = p.yt;
    document.getElementById('p-cat').value = p.category;
    document.getElementById('p-desc').value = p.desc;
    document.getElementById('edit-id').value = i;
    document.getElementById('forge-btn').innerText = "UPDATE ASSET";
    document.getElementById('cancel-edit').style.display = "block";
    document.getElementById('admin-panel').scrollTop = 0;
}

function delItem(i) { if(confirm("DELETE?")) { products.splice(i,1); db.ref('products').set(products); } }
function resetForge() { document.getElementById('edit-id').value = "-1"; document.getElementById('forge-btn').innerText = "DEPLOY ASSET"; document.getElementById('cancel-edit').style.display = "none"; }

// Matrix Effect
const canvas = document.getElementById('global-canvas'); const ctx = canvas.getContext('2d');
let drops = [];
function drawMatrix() {
    ctx.fillStyle = "rgba(0,0,0,0.08)"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#ffd700"; ctx.font = "15px monospace";
    drops.forEach((y, i) => {
        ctx.fillText(String.fromCharCode(0x30A0 + Math.random()*33), i*20, y*20);
        if(y*20 > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
    });
}

window.onload = () => {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    drops = Array(Math.floor(canvas.width/20)).fill(1);
    setInterval(drawMatrix, 50);
    loadProducts();

    // Loader logic
    let bar = document.getElementById('load-bar'), p = 0;
    let int = setInterval(() => {
        p += 2; bar.style.width = p + "%";
        if(p >= 100) { clearInterval(int); document.getElementById('loader-overlay').style.display = 'none'; }
    }, 30);
};

function toggleTheme() { document.body.classList.toggle('blue-theme'); }
</script>
</body>
</html>
